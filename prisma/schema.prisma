generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model SuperAdmin {
  super_admin_id      String    @id @default(uuid()) @db.Uuid
  name                String?
  email               String    @unique
  phone               String?
  password_hash       String
  profile_image       String?
  created_at          DateTime  @default(now()) @db.Timestamptz(6)
  updated_at          DateTime  @updatedAt @db.Timestamptz(6)
  reset_token         String?   @db.VarChar(255)
  reset_token_expires DateTime? @db.Timestamptz(6)
  login_otp           String?   @db.VarChar(32)
  login_otp_expires   DateTime? @db.Timestamptz(6)
  clubs               Club[]    @relation("superadmin_clubs")

  @@map("super_admins")
}

model Club {
  club_id         String           @id @default(uuid()) @db.Uuid
  super_admin_id  String?          @db.Uuid
  club_name       String?
  address         String?
  status          String?          @default("active")
  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime         @default(now()) @db.Timestamptz(6)
  sport           String?
  club_admins     ClubAdmin[]
  super_admin     SuperAdmin?      @relation("superadmin_clubs", fields: [super_admin_id], references: [super_admin_id])
  coaches         Coach[]
  events          Event[]
  players         Player[]
  pod_holders     PodHolder[]
  exerciseTypes   ExerciseType[]
  serviceRequests ServiceRequest[]
  subscriptions   Subscription[]

  @@map("clubs")
}

model ExerciseType {
  exercise_type_id String   @id @default(uuid()) @db.Uuid
  club_id          String   @db.Uuid
  name             String
  event_type       String   @default("training")
  is_system        Boolean  @default(false)
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  updated_at       DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  club Club @relation(fields: [club_id], references: [club_id], onDelete: Cascade)

  @@map("exercise_types")
}

model ClubAdmin {
  admin_id            String    @id @default(uuid()) @db.Uuid
  club_id             String    @db.Uuid
  name                String?
  phone               String?
  email               String?   @unique
  password_hash       String?
  profile_image       String?
  created_at          DateTime  @default(now()) @db.Timestamptz(6)
  updated_at          DateTime  @default(now()) @db.Timestamptz(6)
  reset_token         String?   @db.VarChar(255)
  reset_token_expires DateTime? @db.Timestamptz(6)
  login_otp           String?   @db.VarChar(32)
  login_otp_expires   DateTime? @db.Timestamptz(6)
  temp_password       String?
  club                Club      @relation(fields: [club_id], references: [club_id], onDelete: Cascade)

  @@map("club_admins")
}

model Coach {
  coach_id            String             @id @default(uuid()) @db.Uuid
  club_id             String             @db.Uuid
  coach_name          String?
  phone               String?
  email               String?            @unique
  password_hash       String?
  role                String?
  coach_image         String?
  location            String?
  created_at          DateTime           @default(now()) @db.Timestamptz(6)
  updated_at          DateTime           @default(now()) @db.Timestamptz(6)
  reset_token         String?            @db.VarChar(255)
  reset_token_expires DateTime?          @db.Timestamptz(6)
  login_otp           String?            @db.VarChar(32)
  login_otp_expires   DateTime?          @db.Timestamptz(6)
  coach_assignments   CoachAssignment[]
  club                Club               @relation(fields: [club_id], references: [club_id], onDelete: Cascade)
  event_participants  EventParticipant[]
  pod_allocations     PodAllocation[]

  @@map("coaches")
}

model Player {
  player_id String @id @default(uuid()) @db.Uuid
  club_id   String @db.Uuid

  player_name   String?
  jersey_number Int?
  age           Int?
  position      String?
  phone         String?
  player_image  String?

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  /**
   * One-to-many
   */
  activity_metrics ActivityMetric[]

  coach_assignments  CoachAssignment[]
  event_participants EventParticipant[]
  player_pod_holders PlayerPodHolder[]
  player_pods        PlayerPod[]
  raw_data           RawData[]

  club Club @relation(fields: [club_id], references: [club_id], onDelete: Cascade)
  @@unique([club_id, jersey_number])
  @@map("players")
}

model Pod {
  pod_id            String                @id @default(uuid()) @db.Uuid
  batch_id          String                @db.VarChar(50)
  serial_number     String?               @unique
  device_id         String                @unique
  model             String?
  firmware          String?
  pod_holder_id     String?               @db.Uuid
  lifecycle_status  PodLifecycleStatus    @default(ACTIVE)
  created_at        DateTime              @default(now()) @db.Timestamptz(6)
  updated_at        DateTime              @updatedAt @db.Timestamptz(6)
  coach_assignments CoachAssignment[]
  player_pods       PlayerPod[]
  pod_allocations   PodAllocation[]
  newReplacements   PodReplacementAudit[] @relation("newPod")
  oldReplacements   PodReplacementAudit[] @relation("oldPod")
  pod_statuses      PodStatus[]
  pod_holder        PodHolder?            @relation(fields: [pod_holder_id], references: [pod_holder_id])
  raw_data          RawData[]

  @@index([pod_holder_id])
  @@map("pods")
}

model PodHolder {
  pod_holder_id       String                @id @default(uuid()) @db.Uuid
  serial_number       String?               @unique
  device_id           String?               @unique
  model               String?
  club_id             String?               @db.Uuid
  created_at          DateTime              @default(now()) @db.Timestamptz(6)
  updated_at          DateTime              @updatedAt @db.Timestamptz(6)
  coach_assignments   CoachAssignment[]
  player_pod_holders  PlayerPodHolder[]
  audits              PodHolderAudit[]
  pod_holder_statuses PodHolderStatus[]
  club                Club?                 @relation(fields: [club_id], references: [club_id])
  pod_replacements    PodReplacementAudit[]
  pods                Pod[]

  @@index([club_id])
  @@map("pod_holders")
}

model PodHolderAudit {
  audit_id      String          @id @default(uuid()) @db.Uuid
  pod_holder_id String          @db.Uuid
  from_club_id  String?         @db.Uuid
  to_club_id    String?         @db.Uuid
  action        PodHolderAction
  performed_by  String          @db.Uuid
  created_at    DateTime        @default(now())
  pod_holder    PodHolder       @relation(fields: [pod_holder_id], references: [pod_holder_id])

  @@index([pod_holder_id])
  @@map("pod_holder_audits")
}

model PodReplacementAudit {
  replacement_id String               @id @default(uuid()) @db.Uuid
  pod_holder_id  String               @db.Uuid
  old_pod_id     String               @db.Uuid
  new_pod_id     String?              @db.Uuid
  reason         PodReplacementReason
  performed_by   String               @db.Uuid
  created_at     DateTime             @default(now()) @db.Timestamptz(6)
  new_pod        Pod?                 @relation("newPod", fields: [new_pod_id], references: [pod_id])
  old_pod        Pod                  @relation("oldPod", fields: [old_pod_id], references: [pod_id])
  pod_holder     PodHolder            @relation(fields: [pod_holder_id], references: [pod_holder_id])

  @@index([pod_holder_id])
  @@index([old_pod_id])
  @@map("pod_replacement_audits")
}

model PodAllocation {
  allocation_id String   @id @default(uuid()) @db.Uuid
  coach_id      String?  @db.Uuid
  pod_id        String   @db.Uuid
  battery_level Int?
  health_status String?
  assigned_at   DateTime @default(now()) @db.Timestamptz(6)
  coach         Coach?   @relation(fields: [coach_id], references: [coach_id])
  pod           Pod      @relation(fields: [pod_id], references: [pod_id], onDelete: Cascade)

  @@index([coach_id])
  @@index([pod_id])
  @@map("pod_allocations")
}

model CoachAssignment {
  assignment_id String     @id @default(uuid()) @db.Uuid
  coach_id      String?    @db.Uuid
  pod_id        String?    @db.Uuid
  pod_holder_id String?    @db.Uuid
  player_id     String?    @db.Uuid
  assigned_at   DateTime   @default(now()) @db.Timestamptz(6)
  coach         Coach?     @relation(fields: [coach_id], references: [coach_id], onDelete: Cascade)
  player        Player?    @relation(fields: [player_id], references: [player_id])
  pod_holder    PodHolder? @relation(fields: [pod_holder_id], references: [pod_holder_id])
  pod           Pod?       @relation(fields: [pod_id], references: [pod_id])

  @@index([coach_id])
  @@index([player_id])
  @@map("coach_assignments")
}

model PlayerPod {
  id            String   @id @default(uuid()) @db.Uuid
  player_id     String   @db.Uuid
  pod_id        String   @db.Uuid
  assigned_date DateTime @default(now()) @db.Timestamptz(6)
  player        Player   @relation(fields: [player_id], references: [player_id], onDelete: Cascade)
  pod           Pod      @relation(fields: [pod_id], references: [pod_id], onDelete: Cascade)

  @@unique([pod_id])
  @@index([player_id])
  @@index([pod_id])
  @@map("player_pods")
}

model PlayerPodHolder {
  id            String    @id @default(uuid()) @db.Uuid
  player_id     String    @db.Uuid
  pod_holder_id String    @db.Uuid
  assigned_date DateTime  @default(now()) @db.Timestamptz(6)
  player        Player    @relation(fields: [player_id], references: [player_id], onDelete: Cascade)
  pod_holder    PodHolder @relation(fields: [pod_holder_id], references: [pod_holder_id], onDelete: Cascade)

  @@index([player_id])
  @@index([pod_holder_id])
  @@map("player_pod_holders")
}

model PodStatus {
  status_id      String    @id @default(uuid()) @db.Uuid
  pod_id         String    @db.Uuid
  working_status String?
  battery_level  Int?
  last_sync      DateTime?
  health_status  String?
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  pod            Pod       @relation(fields: [pod_id], references: [pod_id], onDelete: Cascade)

  @@index([pod_id])
  @@map("pod_statuses")
}

model PodHolderStatus {
  status_id      String    @id @default(uuid()) @db.Uuid
  pod_holder_id  String    @db.Uuid
  battery_level  Int?
  working_status String?
  last_sync      DateTime?
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  pod_holder     PodHolder @relation(fields: [pod_holder_id], references: [pod_holder_id], onDelete: Cascade)

  @@index([pod_holder_id])
  @@map("pod_holder_statuses")
}

model RawData {
  raw_id         String    @id @default(uuid()) @db.Uuid
  pod_id         String    @db.Uuid
  player_id      String?   @db.Uuid
  ts             DateTime?
  acceleration_x Float?
  acceleration_y Float?
  acceleration_z Float?
  latitude       Float?
  longitude      Float?
  w              Float?
  x              Float?
  y              Float?
  z              Float?
  distance       Float?
  speed          Float?
  heart_rate     Int?
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  player         Player?   @relation(fields: [player_id], references: [player_id])
  pod            Pod       @relation(fields: [pod_id], references: [pod_id], onDelete: Cascade)

  @@index([pod_id])
  @@index([player_id])
  @@index([ts])
  @@map("raw_data")
}

model Event {
  event_id           String             @id @default(uuid()) @db.Uuid
  club_id            String             @db.Uuid
  event_name         String?
  event_date         DateTime?
  location           String?
  event_type         String?
  created_at         DateTime           @default(now()) @db.Timestamptz(6)
  event_participants EventParticipant[]
  club               Club               @relation(fields: [club_id], references: [club_id], onDelete: Cascade)

  @@map("events")
}

model EventParticipant {
  id        String  @id @default(uuid()) @db.Uuid
  event_id  String  @db.Uuid
  coach_id  String? @db.Uuid
  player_id String? @db.Uuid
  coach     Coach?  @relation(fields: [coach_id], references: [coach_id])
  event     Event   @relation(fields: [event_id], references: [event_id], onDelete: Cascade)
  player    Player? @relation(fields: [player_id], references: [player_id])

  @@index([event_id])
  @@map("event_participants")
}

model PaymentPlan {
  plan_id       String         @id @default(uuid()) @db.Uuid
  name          String?
  price_cents   Int?
  duration_days Int?
  description   String?
  created_at    DateTime       @default(now()) @db.Timestamptz(6)
  subscriptions Subscription[]

  @@map("payment_plans")
}

model Subscription {
  subscription_id String       @id @default(uuid()) @db.Uuid
  club_id         String       @db.Uuid
  plan_id         String?      @db.Uuid
  start_date      DateTime?
  end_date        DateTime?
  status          String?      @default("active")
  created_at      DateTime     @default(now()) @db.Timestamptz(6)
  payments        Payment[]
  club            Club         @relation(fields: [club_id], references: [club_id], onDelete: Cascade)
  plan            PaymentPlan? @relation(fields: [plan_id], references: [plan_id])

  @@map("subscriptions")
}

model Payment {
  payment_id      String       @id @default(uuid()) @db.Uuid
  subscription_id String       @db.Uuid
  amount_cents    Int?
  paid_at         DateTime     @default(now()) @db.Timestamptz(6)
  method          String?
  transaction_ref String?      @unique
  subscription    Subscription @relation(fields: [subscription_id], references: [subscription_id], onDelete: Cascade)

  @@map("payments")
}

model ServiceRequest {
  request_id   String   @id @default(uuid()) @db.Uuid
  club_id      String?  @db.Uuid
  requester_id String?
  description  String?
  status       String?
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @db.Timestamptz(6)
  club         Club?    @relation(fields: [club_id], references: [club_id])

  @@map("service_requests")
}

model ActivityMetric {
  id String @id @default(uuid()) @db.Uuid

  sessionId String @map("session_id")

  /**
   * FK â†’ players.player_id (UUID stored as string in TS)
   */
  playerId String @map("player_id") @db.Uuid
  player   Player @relation(fields: [playerId], references: [player_id], onDelete: Cascade)

  totalDistance    Float? @map("total_distance")
  hsrDistance      Float? @map("hsr_distance")
  sprintDistance   Float? @map("sprint_distance")
  topSpeed         Float? @map("top_speed")
  sprintCount      Int?   @map("sprint_count")
  acceleration     Float?
  deceleration     Float?
  maxAcceleration  Float? @map("max_acceleration")
  maxDeceleration  Float? @map("max_deceleration")
  playerLoad       Float? @map("player_load")
  powerScore       Float? @map("power_score")
  hrMax            Int?   @map("hr_max")
  timeInRedZone    Float? @map("time_in_red_zone")
  percentInRedZone Float? @map("percent_in_red_zone")
  hrRecoveryTime   Float? @map("hr_recovery_time")

  recordedAt DateTime @map("recorded_at") @db.Timestamptz(6)

  @@unique([sessionId, playerId])
  @@index([playerId])
  @@index([recordedAt])
  @@map("activity_metrics")
}

enum PodLifecycleStatus {
  ACTIVE
  ASSIGNED
  DAMAGED
  LOST
  REPLACED
  MAINTENANCE
  RETIRED
  REPAIRED
}

enum PodReplacementReason {
  DAMAGED
  LOST
  UPGRADE
  MAINTENANCE
}

enum PodHolderAction {
  ASSIGNED
  UNASSIGNED
  REASSIGNED
}
